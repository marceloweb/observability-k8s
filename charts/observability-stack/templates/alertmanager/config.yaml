{{- if .Values.alertmanager.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: {{ include "observability-stack.namespace" . }}
  labels:
    {{- include "observability-stack.componentLabels" (dict "component" .Values.alertmanager.name "type" "monitoring" "context" .) | nindent 4 }}
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m

    route:
      {{- with .Values.alertmanager.config.route }}
      {{- toYaml . | nindent 6 }}
      {{- end }}

    receivers:
      {{- range .Values.alertmanager.config.receivers }}
      - name: {{ .name }}
        {{- if .webhook_configs }}
        webhook_configs:
          {{- toYaml .webhook_configs | nindent 10 }}
        {{- end }}
        {{- if .email_configs }}
        email_configs:
          {{- toYaml .email_configs | nindent 10 }}
        {{- end }}
        {{- if .slack_configs }}
        slack_configs:
          {{- toYaml .slack_configs | nindent 10 }}
        {{- end }}
      {{- end }}

    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'cluster', 'service']
{{- end }}